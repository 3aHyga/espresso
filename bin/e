#!/usr/bin/env ruby
require 'fileutils'

src_path = File.expand_path('../../app', __FILE__) + '/'

wd = Dir.pwd + '/'

def fail msg
  puts msg
  exit 1
end

def putm msg
  puts msg
end

if op = $*[0]
  if op =~ /\Ag\:/
    if op =~ /p/ # generating new project
      project_name = $*[1].to_s
      project_name.empty? && fail("Please provide project name as second argument")
      project_name =~ /\.\.|\// && fail("Project name can not contain slashes nor ..")

      project_path = File.expand_path(project_name, wd) + '/'
      File.exists?(project_path) && fail("#{project_path} already exists")

      putm "Generating \"#{project_name}\" project...\n"

      folders, files = Dir[src_path + '**/*'].partition do |entry|
        File.directory?(entry)
      end

      FileUtils.mkdir(project_path)
      putm "  #{project_name}/"
      folders.each do |folder|
        path = folder.sub(src_path, '')
        putm "  `- #{path}"
        FileUtils.mkdir(project_path + path)
      end

      files.each do |file|
        path = file.sub(src_path, '')
        putm "  Writing #{path}"
        FileUtils.cp(file, project_path + path)
      end

      exit 0
    end
  end
end

require "rack"
Rack::Server.start
